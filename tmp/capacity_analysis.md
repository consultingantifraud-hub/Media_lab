# Анализ максимальной емкости системы NeuroStudio

## Текущая конфигурация сервера

### Аппаратные ресурсы
- **CPU:** 8 ядер AMD EPYC @ 2.0GHz
- **RAM:** 7.8 GB (6.0 GB свободно + 4 GB swap)
- **Диск:** 104 GB свободно
- **Нагрузка:** 0.06-0.11 (очень низкая)

### Конфигурация системы
- **Воркеры:** 13 штук (параллельная обработка)
- **API workers:** 4 (FastAPI)
- **PostgreSQL:** max_connections = 200
- **Redis:** maxclients = 10,000
- **Bot:** лимит памяти 1 GB

---

## Расчет пропускной способности

### Параметры операций
- **Таймаут операции:** 240 секунд (4 минуты)
- **Среднее время генерации изображения:** 30-60 секунд (fal.ai API)
- **Время обработки воркером:** ~5-10 секунд (polling, download, save)
- **Общее время на операцию:** ~35-70 секунд

### Пропускная способность воркеров
- **13 воркеров** × **1 задача одновременно** = **13 параллельных операций**
- **Время на операцию:** ~50 секунд (среднее)
- **Операций в минуту:** 13 × (60 / 50) = **~15-16 операций/минуту**
- **Операций в час:** 15 × 60 = **~900 операций/час**
- **Операций в день:** 900 × 24 = **~21,600 операций/день**

---

## Сценарии использования

### Сценарий 1: Легкая нагрузка (1 операция в день на пользователя)
- **Операций в день:** 21,600
- **Пользователей:** 21,600 / 1 = **~21,600 пользователей**

### Сценарий 2: Средняя нагрузка (3 операции в день на пользователя)
- **Операций в день:** 21,600
- **Пользователей:** 21,600 / 3 = **~7,200 пользователей**

### Сценарий 3: Высокая нагрузка (10 операций в день на пользователя)
- **Операций в день:** 21,600
- **Пользователей:** 21,600 / 10 = **~2,160 пользователей**

### Сценарий 4: Пиковая нагрузка (одновременные запросы)
- **Одновременных операций:** 13 (по количеству воркеров)
- **Время обработки:** ~50 секунд
- **Пользователей в пик:** зависит от частоты запросов
  - Если каждый пользователь делает 1 запрос в час: **~780 пользователей** (13 × 60)
  - Если каждый пользователь делает 1 запрос в 10 минут: **~130 пользователей** (13 × 10)

---

## Ограничения по ресурсам

### 1. CPU (8 ядер)
- **Текущее использование:** <1%
- **Запас:** 99%
- **Ограничение:** Не является узким местом
- **Максимальная нагрузка:** Может обрабатывать до 100% CPU (8 ядер × 100% = 8 параллельных задач на ядро)
- **Теоретический максимум:** 8 × 13 = 104 параллельных задач (но воркеров только 13)

### 2. RAM (7.8 GB + 4 GB swap)
- **Текущее использование:** 1.7 GB / 7.8 GB (22%)
- **Запас:** 6.0 GB + 4 GB swap = 10 GB
- **На пользователя (активного):** ~5-10 MB (соединение, кеш)
- **Максимально активных пользователей:** 10,000 MB / 10 MB = **~1,000 одновременных активных пользователей**

### 3. PostgreSQL (max_connections = 200)
- **Текущее использование:** 3-5 подключений
- **Запас:** 195-197 подключений
- **Ограничение:** 200 одновременных подключений
- **Максимально активных пользователей:** **~200** (если каждый держит соединение)

### 4. Redis (maxclients = 10,000)
- **Текущее использование:** ~10 MB
- **Запас:** Огромный
- **Ограничение:** Не является узким местом
- **Максимально активных пользователей:** **~10,000**

### 5. Воркеры (13 штук)
- **Ограничение:** 13 параллельных операций
- **Это узкое место системы!**

---

## Узкие места системы

### Главное узкое место: Количество воркеров
- **Текущее:** 13 воркеров
- **Максимум параллельных операций:** 13
- **Влияние:** Определяет пропускную способность системы

### Вторичное узкое место: PostgreSQL connections
- **Текущее:** max_connections = 200
- **Влияние:** Ограничивает количество одновременных активных пользователей

---

## Реалистичные оценки емкости

### Консервативная оценка (с запасом 50%)
- **Операций в день:** 21,600 × 0.5 = **10,800 операций/день**
- **При средней нагрузке (3 оп/день):** 10,800 / 3 = **~3,600 пользователей**
- **При легкой нагрузке (1 оп/день):** 10,800 / 1 = **~10,800 пользователей**

### Оптимистичная оценка (максимальная нагрузка)
- **Операций в день:** **21,600 операций/день**
- **При средней нагрузке (3 оп/день):** 21,600 / 3 = **~7,200 пользователей**
- **При легкой нагрузке (1 оп/день):** **~21,600 пользователей**

### Реалистичная оценка (с учетом пиков)
- **Операций в день:** **~15,000 операций/день** (с учетом неравномерности нагрузки)
- **При средней нагрузке (3 оп/день):** 15,000 / 3 = **~5,000 пользователей**
- **При легкой нагрузке (1 оп/день):** **~15,000 пользователей**

---

## Рекомендации по масштабированию

### Для увеличения емкости:

1. **Добавить воркеров** (самое эффективное)
   - Текущее: 13 воркеров
   - Можно добавить до 20-30 воркеров
   - Увеличение емкости: линейное (13 → 20 = +54% емкости)

2. **Увеличить max_connections PostgreSQL**
   - Текущее: 200
   - Можно увеличить до 300-500
   - Увеличение емкости: для одновременных пользователей

3. **Оптимизировать время обработки**
   - Использовать более быстрые модели (если доступны)
   - Кеширование результатов
   - Увеличение емкости: +20-30%

### Потенциал с оптимизацией:
- **С 20 воркерами:** ~11,000 пользователей (средняя нагрузка)
- **С 30 воркерами:** ~16,500 пользователей (средняя нагрузка)
- **С оптимизацией + 30 воркерами:** ~20,000+ пользователей (средняя нагрузка)

---

## Итоговая оценка

### Текущая конфигурация (13 воркеров):
- **Реалистичная емкость:** **~5,000 пользователей** (при средней нагрузке 3 оп/день)
- **Максимальная емкость:** **~7,200 пользователей** (при средней нагрузке 3 оп/день)
- **При легкой нагрузке:** **~15,000-21,600 пользователей** (1 оп/день)

### С учетом узких мест:
- **Ограничение по воркерам:** 13 параллельных операций
- **Ограничение по PostgreSQL:** 200 одновременных подключений
- **Ограничение по RAM:** ~1,000 одновременных активных пользователей

### Вывод:
**Система может обрабатывать 5,000-7,200 активных пользователей** при средней нагрузке (3 операции в день) с текущей конфигурацией.

Для увеличения емкости рекомендуется добавить воркеров (самое эффективное решение).




