# Документация по моделям ретуши

## Обзор

В боте используются две модели для ретуши изображений, каждая из которых работает в своем режиме:

1. **`fal-ai/retoucher`** — режим "Мягкая ретушь" (soft)
2. **`fal-ai/image-editing/face-enhancement`** — режим "Усилить черты" (enhance)

## Как работает ретушь

### Процесс обработки:

1. **Пользователь загружает изображение** → бот сохраняет его локально
2. **Пользователь выбирает режим** → "Мягкая ретушь" или "Усилить черты"
3. **Пользователь может указать дополнительную инструкцию** (опционально)
4. **Бот формирует финальный промпт** и отправляет запрос в модель
5. **Модель обрабатывает изображение** асинхронно через queue API
6. **Результат отправляется пользователю**

## Формирование промпта

### Базовые промпты (заданы в коде)

#### Режим "Мягкая ретушь" (soft):
```
Delicate face retouch. Remove small blemishes and even the skin tone while preserving natural pores, texture, and details. 
Keep the original face structure, facial features, and identity exactly the same. 
Only remove imperfections, do not change face shape, eyes, nose, or mouth structure. 
Avoid over-smoothing the eyes and lips. Maintain realistic skin texture.
```

**Что делает:**
- Удаляет мелкие дефекты кожи
- Выравнивает тон кожи
- Сохраняет естественную текстуру и поры
- **НЕ изменяет** структуру лица, форму глаз, носа, рта
- Избегает излишнего сглаживания

#### Режим "Усилить черты" (enhance):
```
Enhance facial features with natural clarity while preserving the original face identity. 
Keep the exact same face structure, proportions, and appearance. 
Accentuate the eyes, lips, and contours subtly while keeping skin texture realistic. 
Do not change face shape, bone structure, or facial features. Only enhance clarity and definition.
```

**Что делает:**
- Улучшает четкость черт лица
- Подчеркивает глаза, губы и контуры
- Сохраняет структуру лица и пропорции
- **НЕ изменяет** форму лица, костную структуру
- Только улучшает четкость и определение

### Как влияет промпт пользователя

Если пользователь указал дополнительную инструкцию (например, "убери прыщи" или "сделай кожу более гладкой"):

1. **Инструкция переводится на английский** (если была на русском)
2. **Добавляется к базовому промпту** в формате:
   ```
   {базовый_промпт}
   Additional instruction: {инструкция_пользователя}
   ```

**Пример:**
- Базовый промпт: "Delicate face retouch..."
- Инструкция пользователя: "убери прыщи на лбу"
- Финальный промпт:
  ```
  Delicate face retouch. Remove small blemishes and even the skin tone while preserving natural pores, texture, and details. 
  Keep the original face structure, facial features, and identity exactly the same. 
  Only remove imperfections, do not change face shape, eyes, nose, or mouth structure. 
  Avoid over-smoothing the eyes and lips. Maintain realistic skin texture.
  Additional instruction: remove pimples on the forehead
  ```

## Технические детали

### Параметры запроса:

- **Модель**: определяется режимом (soft/enhance)
- **Изображение**: передается как base64 data URL
- **Промпт**: базовый промпт + инструкция пользователя (если есть)
- **Формат вывода**: PNG
- **Максимальный размер файла**: 10 МБ

### Обработка:

- Используется **queue API** (асинхронная обработка)
- Polling каждую секунду до завершения (максимум 240 попыток = 4 минуты)
- Результат отправляется по URL (Telegram скачивает файл со своей стороны)

## Рекомендации по использованию

### Когда использовать "Мягкая ретушь":
- Удаление мелких дефектов (прыщи, пятна)
- Выравнивание тона кожи
- Сохранение естественного вида
- Портреты для профессионального использования

### Когда использовать "Усилить черты":
- Улучшение четкости черт лица
- Подчеркивание глаз и губ
- Улучшение контуров лица
- Фотографии для публикации в соцсетях

### Как формулировать инструкции:

✅ **Хорошие примеры:**
- "убери прыщи на лбу"
- "сделай кожу более гладкой"
- "убери темные круги под глазами"
- "выровняй тон кожи"
- "убери морщины вокруг глаз"

❌ **Плохие примеры (могут не сработать):**
- "измени форму носа" (модель не должна изменять структуру лица)
- "сделай глаза больше" (изменение пропорций)
- "измени цвет волос" (это не ретушь, а редактирование)

## Важные ограничения

1. **Модели НЕ изменяют структуру лица** — они только улучшают качество и убирают дефекты
2. **Максимальный размер файла**: 10 МБ (если больше — пользователь получит сообщение об ошибке)
3. **Обработка может занять до 4 минут** (обычно быстрее)
4. **Промпт пользователя добавляется к базовому**, а не заменяет его — это гарантирует сохранение структуры лица

## Отличия от других моделей редактирования

| Модель | Назначение | Изменяет структуру? |
|--------|-----------|---------------------|
| `fal-ai/retoucher` | Мягкая ретушь лица | ❌ Нет |
| `fal-ai/image-editing/face-enhancement` | Улучшение черт лица | ❌ Нет |
| `fal-ai/chrono-edit` | Редактирование по тексту | ✅ Да (может изменять объекты) |
| `fal-ai/bytedance/seedream/v4/edit` | Редактирование с добавлением объектов/текста | ✅ Да |

## Примеры использования

### Пример 1: Простая ретушь без инструкций
- **Режим**: Мягкая ретушь
- **Инструкция**: (пусто)
- **Результат**: Автоматическая ретушь с удалением мелких дефектов

### Пример 2: Ретушь с конкретной инструкцией
- **Режим**: Мягкая ретушь
- **Инструкция**: "убери прыщи на лбу и подбородке"
- **Результат**: Ретушь с акцентом на удаление прыщей в указанных областях

### Пример 3: Улучшение черт
- **Режим**: Усилить черты
- **Инструкция**: "подчеркни глаза и губы"
- **Результат**: Улучшенная четкость глаз и губ при сохранении естественности





