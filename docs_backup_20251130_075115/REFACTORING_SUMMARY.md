# –û—Ç—á–µ—Ç –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –∫–æ–¥–∞

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –£–¥–∞–ª–µ–Ω –≤–µ—Å—å –≤–∏–¥–µ–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

**–£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚ùå `app/bot/handlers/video.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∏–¥–µ–æ
- ‚ùå `app/workers/video_worker.py` - –≤–æ—Ä–∫–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ
- ‚ùå `app/providers/fal/videos.py` - –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤–∏–¥–µ–æ API

**–£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- ‚ùå `enqueue_video()` –∏–∑ `app/bot/services/jobs.py`
- ‚ùå `get_video_queue()` –∏–∑ `app/core/queues.py`
- ‚ùå `get_video_model()` –∏–∑ `app/providers/fal/models_map.py`
- ‚ùå `register_video_handlers()` –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–£–¥–∞–ª–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
- ‚ùå `video_poll_interval` –∏–∑ config
- ‚ùå `video_max_wait_sec` –∏–∑ config
- ‚ùå `videos_dir` property –∏–∑ config

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–¥ —Å—Ç–∞–ª –ø—Ä–æ—â–µ –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö.

---

### 2. –£–ø—Ä–æ—â–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á

**–§–∞–π–ª:** `app/core/queues.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω–∞ `VID_QUEUE_NAME` –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞
- –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_video_queue()`
- –£–ø—Ä–æ—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_job()` - —Ç–µ–ø–µ—Ä—å –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ –≤ `img_queue`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–µ–Ω—å—à–µ –∫–æ–¥–∞, –ø—Ä–æ—â–µ –ª–æ–≥–∏–∫–∞.

---

### 3. –û—á–∏—â–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã

**–£–¥–∞–ª–µ–Ω–æ:**
- ‚ùå `build_upscale_keyboard` –∏–∑ `image_worker.py` (–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª—Å—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è)
- ‚ùå `run_face_swap`, `run_image_edit`, `run_image_upscale` –∏–∑ –∏–º–ø–æ—Ä—Ç–æ–≤ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –≤–æ—Ä–∫–µ—Ä–∞—Ö)
- ‚ùå –í–∏–¥–µ–æ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ `app/providers/fal/__init__.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ß–∏—â–µ –∏–º–ø–æ—Ä—Ç—ã, –º–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

---

### 4. –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

**–£–¥–∞–ª–µ–Ω–æ –∏–∑ `image_worker.py`:**
- ‚ùå `UPSCALE_MIN_FILE_BYTES` - –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å
- ‚ùå `UPSCALE_MAX_FILE_BYTES` - –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å
- ‚ùå `FAST_EDIT_MODELS` - –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–µ–Ω—å—à–µ "–º–µ—Ä—Ç–≤–æ–≥–æ" –∫–æ–¥–∞.

---

### 5. –£–ø—Ä–æ—â–µ–Ω storage

**–§–∞–π–ª:** `app/core/storage.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ `videos/`
- –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ `face_swap/` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

---

### 6. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω docker-compose

**–§–∞–π–ª:** `docker/docker-compose.yml`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω —Å–µ—Ä–≤–∏—Å `worker-video`
- –î–æ–±–∞–≤–ª–µ–Ω `restart: unless-stopped` –¥–ª—è `worker-image`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ—â–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã.

---

### 7. –ò–∑–º–µ–Ω–µ–Ω —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `app/core/config.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `log_level` –∏–∑–º–µ–Ω–µ–Ω —Å `DEBUG` –Ω–∞ `INFO` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- DEBUG —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–µ–Ω—å—à–µ –ª–æ–≥–æ–≤ –≤ production, –ª—É—á—à–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –£–¥–∞–ª–µ–Ω–æ:
- **3 —Ñ–∞–π–ª–∞** (video.py, video_worker.py, videos.py)
- **~200 —Å—Ç—Ä–æ–∫** –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞
- **5 —Ñ—É–Ω–∫—Ü–∏–π** —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –≤–∏–¥–µ–æ
- **3 –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã** –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

### –£–ø—Ä–æ—â–µ–Ω–æ:
- –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (—Ç–æ–ª—å–∫–æ img_queue)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–±–µ–∑ –≤–∏–¥–µ–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
- Docker compose (–±–µ–∑ video –≤–æ—Ä–∫–µ—Ä–∞)
- –ò–º–ø–æ—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)

---

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞ 30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–æ–¥–∏–Ω –≤–æ—Ä–∫–µ—Ä):

**docker-compose.yml:**
- ‚úÖ 1 –±–æ—Ç
- ‚úÖ 1 –≤–æ—Ä–∫–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ Redis
- ‚úÖ API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –î–æ 30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ connection pools
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ Rate limiting –≥–æ—Ç–æ–≤ (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)

---

## üìã –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ 30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö:

1. ‚úÖ **–ö–æ–¥ –≥–æ—Ç–æ–≤** - –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
2. ‚è≠Ô∏è **–î–æ–±–∞–≤–∏—Ç—å rate limiting** –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞)
3. ‚è≠Ô∏è **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ 100-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

1. ‚è≠Ô∏è –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Ä–∫–µ—Ä—ã: `docker-compose up -d --scale worker-image=5-10`
2. ‚è≠Ô∏è –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å polling –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `polling_config.py`)
3. ‚è≠Ô∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis —Å maxmemory

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —Å –æ–¥–Ω–∏–º –≤–æ—Ä–∫–µ—Ä–æ–º
docker-compose up -d

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker-compose ps

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥—å
redis-cli LLEN rq:queue:img_queue

# 4. –õ–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞
docker-compose logs -f worker-image
```

---

## ‚úÖ –ò—Ç–æ–≥–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

**–ö–æ–¥ —Å—Ç–∞–ª:**
- ‚úÖ –ü—Ä–æ—â–µ (—É–¥–∞–ª–µ–Ω–æ ~200 —Å—Ç—Ä–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞)
- ‚úÖ –ß–∏—â–µ (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∏–º–ø–æ—Ä—Ç—ã)
- ‚úÖ –°—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω–µ–µ (—Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
- ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞ 30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
- ‚úÖ –ì–æ—Ç–æ–≤ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

**–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –ª–∏–Ω—Ç–µ—Ä–æ–º - –æ—à–∏–±–æ–∫ –Ω–µ—Ç!**




