# –ü–ª–∞–Ω –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è 100-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ vs –¢—Ä–µ–±—É–µ–º–æ–µ

**–¢–µ–∫—É—â–µ–µ:**
- 1 –±–æ—Ç-–ø—Ä–æ—Ü–µ—Å—Å (long polling)
- 1 –≤–æ—Ä–∫–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- 1 –≤–æ—Ä–∫–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ
- –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤
- Polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

**–¢—Ä–µ–±—É–µ–º–æ–µ –¥–ª—è 100-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã –±–æ—Ç–∞
- 5-10 –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- 2-3 –≤–æ—Ä–∫–µ—Ä–∞ –¥–ª—è –≤–∏–¥–µ–æ
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π polling
- Rate limiting
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

### 1. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω –≤–æ—Ä–∫–µ—Ä –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—Å—è —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π 100-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤

**docker-compose.yml:**
```yaml
worker-image-1:
  build:
    context: ..
    dockerfile: docker/Dockerfile.worker
  env_file:
    - ../.env
  command: rq worker -u ${redis_url:-redis://redis:6379/0} img_queue
  volumes:
    - ../media:/app/media

worker-image-2:
  # ... —Ç–æ –∂–µ —Å–∞–º–æ–µ

worker-image-3:
  # ... —Ç–æ –∂–µ —Å–∞–º–æ–µ

# –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–æ 5-10 –≤–æ—Ä–∫–µ—Ä–æ–≤
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å scale –≤ docker-compose:**
```bash
docker-compose up --scale worker-image=5 --scale worker-video=2
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 
- **5-7 –≤–æ—Ä–∫–µ—Ä–æ–≤** –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (img_queue)
- **2-3 –≤–æ—Ä–∫–µ—Ä–∞** –¥–ª—è –≤–∏–¥–µ–æ (vid_queue)

---

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Polling –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** Polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –ø—Ä–∏ 100-300 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö = 100-300 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ –∫ API.

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª polling —Å exponential backoff

**–§–∞–π–ª:** `app/workers/image_worker.py`

```python
# –í–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ 1.0 —Å–µ–∫
POLL_INTERVAL_INITIAL = 2.0  # –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
POLL_INTERVAL_MAX = 10.0     # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
POLL_BACKOFF_MULTIPLIER = 1.2  # –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è

# –í —Ñ—É–Ω–∫—Ü–∏—è—Ö polling:
poll_interval = POLL_INTERVAL_INITIAL
while True:
    status = check_image_status(task_id)
    if status["status"] == "succeeded":
        break
    if status["status"] == "failed":
        # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
        break
    
    time.sleep(poll_interval)
    poll_interval = min(poll_interval * POLL_BACKOFF_MULTIPLIER, POLL_INTERVAL_MAX)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API —Å 100-300 req/sec –¥–æ 20-50 req/sec.

---

### 3. Rate Limiting –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å rate limiting —á–µ—Ä–µ–∑ Redis

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `app/core/rate_limit.py`

```python
from __future__ import annotations

import time
from app.core.redis import get_redis_connection

RATE_LIMIT_WINDOW = 60  # —Å–µ–∫—É–Ω–¥—ã
RATE_LIMIT_MAX_REQUESTS = 10  # –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É

def check_rate_limit(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç rate limit –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ –º–æ–∂–Ω–æ."""
    redis_client = get_redis_connection()
    key = f"rate_limit:{user_id}"
    current = redis_client.get(key)
    
    if current is None:
        redis_client.setex(key, RATE_LIMIT_WINDOW, 1)
        return True
    
    count = int(current)
    if count >= RATE_LIMIT_MAX_REQUESTS:
        return False
    
    redis_client.incr(key)
    return True
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:**
```python
from app.core.rate_limit import check_rate_limit

async def handle_create(message: types.Message, state: FSMContext) -> None:
    user_id = message.from_user.id if message.from_user else 0
    if not check_rate_limit(user_id):
        await message.answer(
            "‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
        )
        return
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

---

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Redis ‚ö†Ô∏è –í–ê–ñ–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ Redis –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º.

**–†–µ—à–µ–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis –¥–ª—è production

**docker-compose.yml:**
```yaml
redis:
  image: redis:7-alpine
  restart: unless-stopped
  command: >
    redis-server
    --maxmemory 2gb
    --maxmemory-policy allkeys-lru
    --save 60 1000
    --appendonly yes
  volumes:
    - redis-data:/data
  ports:
    - "6379:6379"
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis Sentinel –¥–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.**

---

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏ ‚ö†Ô∏è –í–ê–ñ–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑ –º–µ—Ç—Ä–∏–∫.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `app/core/metrics.py`

```python
from prometheus_client import Counter, Histogram, Gauge
from prometheus_client import start_http_server

# –ú–µ—Ç—Ä–∏–∫–∏
jobs_total = Counter('jobs_total', 'Total jobs', ['type', 'status'])
job_duration = Histogram('job_duration_seconds', 'Job duration', ['type'])
queue_size = Gauge('queue_size', 'Queue size', ['queue_name'])
active_workers = Gauge('active_workers', 'Active workers', ['queue_name'])

def start_metrics_server(port: int = 9090):
    start_http_server(port)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from app.core.metrics import jobs_total, job_duration

@job_duration.labels(type='image').time()
def process_image_job(...):
    jobs_total.labels(type='image', status='started').inc()
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞
    jobs_total.labels(type='image', status='completed').inc()
```

---

## üîß –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 6. Webhook –≤–º–µ—Å—Ç–æ Long Polling (–¥–ª—è production)

**–ü—Ä–æ–±–ª–µ–º–∞:** Long polling –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è —Ö–æ—Ä–æ—à–æ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å webhook –¥–ª—è –±–æ—Ç–∞

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `app/bot/webhook.py`

```python
from fastapi import FastAPI, Request
from aiogram import Bot, Dispatcher
from aiogram.types import Update

app = FastAPI()
bot = Bot(token=settings.tg_bot_token)
dp = build_dispatcher()

@app.post("/webhook")
async def webhook_handler(request: Request):
    data = await request.json()
    update = Update(**data)
    await dp.feed_update(bot, update)
    return {"ok": True}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã –±–æ—Ç–∞ —á–µ—Ä–µ–∑ load balancer
- –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Telegram API

---

### 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö.

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**

**A. –û–±—â–∏–π NFS/GlusterFS volume:**
```yaml
volumes:
  media-storage:
    driver: local
    driver_opts:
      type: nfs
      o: addr=nfs-server,nolock,soft
      device: ":/media"
```

**B. S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:**
```python
import boto3
from app.core.config import settings

s3_client = boto3.client('s3',
    endpoint_url=settings.s3_endpoint,
    aws_access_key_id=settings.s3_key,
    aws_secret_access_key=settings.s3_secret
)

def save_to_s3(file_path: Path, key: str) -> str:
    s3_client.upload_file(str(file_path), settings.s3_bucket, key)
    return f"{settings.s3_endpoint}/{settings.s3_bucket}/{key}"
```

---

### 8. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ.

**–†–µ—à–µ–Ω–∏–µ:** –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Redis

```python
import hashlib
import json

def get_cache_key(prompt: str, options: dict) -> str:
    data = json.dumps({"prompt": prompt, **options}, sort_keys=True)
    return f"cache:{hashlib.md5(data.encode()).hexdigest()}"

def get_cached_result(prompt: str, options: dict) -> str | None:
    key = get_cache_key(prompt, options)
    return redis_client.get(key)

def cache_result(prompt: str, options: dict, result_url: str, ttl: int = 3600):
    key = get_cache_key(prompt, options)
    redis_client.setex(key, ttl, result_url)
```

---

### 9. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –∑–∞–¥–∞—á–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ RQ

```python
from rq import Queue
from rq.job import Job

high_priority_queue = Queue('img_queue_high', connection=get_redis_connection())
normal_queue = Queue('img_queue', connection=get_redis_connection())

# –î–ª—è VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
high_priority_queue.enqueue(process_image_job, ...)

# –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
normal_queue.enqueue(process_image_job, ...)
```

---

### 10. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–æ—Ä–∫–µ—Ä—ã –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É

**docker-compose.yml:**
```yaml
worker-image:
  # ...
  mem_limit: 2g
  memswap_limit: 2g
  oom_kill_disable: false
```

**–í –∫–æ–¥–µ:**
```python
import gc

def process_image_job(...):
    try:
        # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞
    finally:
        gc.collect()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
```

---

## üìã –ü–û–®–ê–ì–û–í–´–ô –ü–õ–ê–ù –í–ù–ï–î–†–ï–ù–ò–Ø

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (1-2 –¥–Ω—è)

1. ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å 5 –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å 2 –≤–æ—Ä–∫–µ—Ä–∞ –¥–ª—è –≤–∏–¥–µ–æ
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

2. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è polling**
   - –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 2-3 —Å–µ–∫—É–Ω–¥
   - –î–æ–±–∞–≤–∏—Ç—å exponential backoff
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

3. ‚úÖ **Rate limiting**
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π rate limiting
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–º–∏—Ç—ã (10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É)
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –§–∞–∑–∞ 2: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (3-5 –¥–Ω–µ–π)

4. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏
   - –î–æ–±–∞–≤–∏—Ç—å Grafana –¥–∞—à–±–æ—Ä–¥—ã
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã

5. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Redis**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å maxmemory –∏ –ø–æ–ª–∏—Ç–∏–∫—É
   - –í–∫–ª—é—á–∏—Ç—å persistence
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

6. ‚úÖ **Webhook (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å webhook endpoint
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å load balancer
   - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å polling –Ω–∞ webhook

### –§–∞–∑–∞ 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (1-2 –Ω–µ–¥–µ–ª–∏)

7. ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TTL
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å hit rate

8. ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è**
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

9. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—â–∏–π volume –∏–ª–∏ S3
   - –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã

---

## üñ•Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è 100-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

**VPS/–°–µ—Ä–≤–µ—Ä:**
- **CPU:** 8-16 —è–¥–µ—Ä
- **RAM:** 16-32 GB
- **–î–∏—Å–∫:** 200+ GB SSD (–∏–ª–∏ S3 –¥–ª—è –º–µ–¥–∏–∞)
- **–°–µ—Ç—å:** –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –º–∏–Ω–∏–º—É–º 100 Mbps

**Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```yaml
services:
  redis:
    # ... —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –≤—ã—à–µ
    
  bot:
    # 1-2 –∏–Ω—Å—Ç–∞–Ω—Å–∞ (–∏–ª–∏ webhook)
    deploy:
      replicas: 1
      
  worker-image:
    # 5-7 –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
    deploy:
      replicas: 5
      resources:
        limits:
          cpus: '2'
          memory: 2G
          
  worker-video:
    # 2-3 –∏–Ω—Å—Ç–∞–Ω—Å–∞
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '2'
          memory: 4G
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–ê–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

### –ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:

- **100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ
- **200 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
- **300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–º–æ–∂–Ω—ã –ø–∏–∫–æ–≤—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

- **–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏:** < 30 —Å–µ–∫—É–Ω–¥
- **–†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏:** < 50 –∑–∞–¥–∞—á
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU:** < 70%
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:** < 80%
- **–û—à–∏–±–∫–∏:** < 1%

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–∞—á–Ω–∏—Ç–µ —Å 5 –≤–æ—Ä–∫–µ—Ä–æ–≤ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω:** –ë–µ–∑ –º–µ—Ç—Ä–∏–∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ production
4. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±—ç–∫–∞–ø—ã Redis –∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤
5. **–ê–ª–µ—Ä—Ç—ã:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢

–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
# 1. –û–±–Ω–æ–≤–∏—Ç–µ docker-compose.yml (–¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –≤–æ—Ä–∫–µ—Ä–æ–≤)
# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
docker-compose up --scale worker-image=5 --scale worker-video=2

# 3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –æ—á–µ—Ä–µ–¥–∏
redis-cli LLEN rq:queue:img_queue
redis-cli LLEN rq:queue:vid_queue

# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤
docker-compose logs -f worker-image
```

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ 100-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –Ω—É–∂–Ω–æ:

1. ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Ä–∫–µ—Ä—ã (5-7 –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, 2-3 –¥–ª—è –≤–∏–¥–µ–æ)
2. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å polling (2-3 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 1 —Å–µ–∫)
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å rate limiting
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–û—Å—Ç–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è** (webhook, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, S3) –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä—è—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –Ω–∞–≥—Ä—É–∑–∫–∏.




