#!/bin/bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å (07:00 –∏ 16:00)

REPO_DIR="/opt/media-lab"
SCRIPT_PATH="$REPO_DIR/auto_commit.sh"
CRON_LOG="/opt/media-lab/logs/git_cron.log"

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å ==="
echo ""

cd "$REPO_DIR" || { echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ $REPO_DIR"; exit 1; }

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç $SCRIPT_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω."
    echo "–°–æ–∑–¥–∞—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é..."
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å
    if [ -f "$REPO_DIR/auto_commit_advanced.sh" ]; then
        cp "$REPO_DIR/auto_commit_advanced.sh" "$SCRIPT_PATH"
        chmod +x "$SCRIPT_PATH"
        echo "‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–º–º–∏—Ç–∞"
        exit 1
    fi
fi

chmod +x "$SCRIPT_PATH"
echo "‚úÖ –°–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤: $SCRIPT_PATH"

# 2. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p "$(dirname "$CRON_LOG")"
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∞"

# 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π cron
echo ""
echo "=== –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ cron (Git) ==="
crontab -l 2>/dev/null | grep -E "auto_commit|git" || echo "–ù–µ—Ç –∑–∞–¥–∞—á Git –≤ cron"
echo ""

# 4. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ Git
echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
crontab -l 2>/dev/null | grep -v "auto_commit.sh" | crontab - 2>/dev/null
echo "‚úÖ –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ —É–¥–∞–ª–µ–Ω—ã"

# 5. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å)
echo ""
echo "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
echo "  - 07:00 (—É—Ç—Ä–æ–º)"
echo "  - 16:00 (–≤–µ—á–µ—Ä–æ–º)"

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π crontab
TEMP_CRON=$(mktemp)
crontab -l 2>/dev/null > "$TEMP_CRON"

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
cat >> "$TEMP_CRON" << EOF

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ GitHub (Media Lab)
0 7 * * * $SCRIPT_PATH >> $CRON_LOG 2>&1
0 16 * * * $SCRIPT_PATH >> $CRON_LOG 2>&1
EOF

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π crontab
crontab "$TEMP_CRON"
rm "$TEMP_CRON"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ó–∞–¥–∞—á–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ cron!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á –≤ cron."
    exit 1
fi

# 6. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
echo ""
echo "=== –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ==="
crontab -l | grep "auto_commit.sh"
echo ""

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ ==="
echo "‚è∞ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 07:00"
echo "‚è∞ –í—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 16:00"
echo ""
echo "üìã –°–∫—Ä–∏–ø—Ç: $SCRIPT_PATH"
echo "üìù –õ–æ–≥–∏: $CRON_LOG"
echo ""

# 8. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
echo "–•–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–µ–π—á–∞—Å? (y/n): "
read -t 5 TEST_RUN || TEST_RUN="n"

if [ "$TEST_RUN" = "y" ] || [ "$TEST_RUN" = "Y" ]; then
    echo ""
    echo "=== –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ ==="
    bash "$SCRIPT_PATH"
    echo ""
    echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f $CRON_LOG"
else
    echo ""
    echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo ""
    echo "–î–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "  bash $SCRIPT_PATH"
fi

echo ""
echo "üìö –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: crontab -l | grep auto_commit"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f $CRON_LOG"
echo "  - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫: bash $SCRIPT_PATH"
echo "  - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å cron: crontab -e"

