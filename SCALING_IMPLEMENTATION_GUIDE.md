# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è 100-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –®–∞–≥ 1: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ (5 –º–∏–Ω—É—Ç)

**–í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ docker-compose scale**

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
# –î–ª—è 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 5 –≤–æ—Ä–∫–µ—Ä–æ–≤
# –î–ª—è 200 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 7 –≤–æ—Ä–∫–µ—Ä–æ–≤
# –î–ª—è 300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 10 –≤–æ—Ä–∫–µ—Ä–æ–≤
docker-compose up -d --scale worker-image=7

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
docker-compose ps
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞**

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–π compose —Ñ–∞–π–ª (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ 7 –≤–æ—Ä–∫–µ—Ä–æ–≤)
docker-compose -f docker-compose.yml -f docker/docker-compose.scaled.yml up -d
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Rate Limiting (10 –º–∏–Ω—É—Ç)

**1. Rate limiting —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ `app/core/rate_limit.py`**

**2. –î–æ–±–∞–≤—å—Ç–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**

**–§–∞–π–ª:** `app/bot/handlers/image.py`

```python
from app.core.rate_limit import check_rate_limit, get_rate_limit_remaining

async def handle_create(message: types.Message, state: FSMContext) -> None:
    user_id = message.from_user.id if message.from_user else 0
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
    if not check_rate_limit(user_id):
        remaining = get_rate_limit_remaining(user_id)
        await message.answer(
            f"‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. "
            f"–ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.\n"
            f"–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: {remaining}"
        )
        return
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∫ –æ—Å–Ω–æ–≤–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º:**
- `handle_create`
- `handle_edit_start`
- `handle_smart_merge_start`
- `handle_retoucher_start`
- `handle_upscale_button`

### –®–∞–≥ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Polling (15 –º–∏–Ω—É—Ç)

**1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å `app/core/polling_config.py`**

**2. –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ polling –≤ `app/workers/image_worker.py`:**

**–ü—Ä–∏–º–µ—Ä –¥–ª—è `process_image_job`:**

```python
from app.core.polling_config import PollingConfig, IMAGE_POLL_MAX_ATTEMPTS

def process_image_job(...):
    # ...
    poll_config = PollingConfig(
        initial_interval=2.0,
        max_interval=10.0,
        max_attempts=IMAGE_POLL_MAX_ATTEMPTS
    )
    
    while True:
        status = check_image_status(task_id)
        current_status = status.get("status")
        if current_status == "succeeded":
            break
        if current_status == "failed":
            # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
            break
        
        poll_attempts += 1
        if poll_attempts >= poll_config.max_attempts:
            # —Ç–∞–π–º–∞—É—Ç
            break
        
        interval = poll_config.get_interval()
        time.sleep(interval)
```

### –®–∞–≥ 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Prometheus –∏ Grafana:**

```bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ docker-compose.yml
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π:

```bash
# –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
redis-cli LLEN rq:queue:img_queue

# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
redis-cli KEYS "rq:job:*" | wc -l

# –ó–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥–∏
redis-cli LRANGE rq:queue:img_queue 0 -1
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤:

```bash
# –õ–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤
docker-compose logs -f worker-image

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Redis
redis-cli INFO stats
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limiting:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
redis-cli GET "rate_limit:123456789"
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### Rate Limiting (`app/core/rate_limit.py`):

```python
RATE_LIMIT_WINDOW = 60        # –û–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–∫—É–Ω–¥—ã)
RATE_LIMIT_MAX_REQUESTS = 10  # –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- **200-300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 8-10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É

### Polling (`app/core/polling_config.py`):

```python
POLL_INTERVAL_INITIAL = 2.0   # –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
POLL_INTERVAL_MAX = 10.0      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **–ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:** 1-2 —Å–µ–∫—É–Ω–¥—ã
- **–°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞:** 2-3 —Å–µ–∫—É–Ω–¥—ã
- **–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:** 3-5 —Å–µ–∫—É–Ω–¥

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è):

- **100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 5 –≤–æ—Ä–∫–µ—Ä–æ–≤
- **200 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 7 –≤–æ—Ä–∫–µ—Ä–æ–≤
- **300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 10 –≤–æ—Ä–∫–µ—Ä–æ–≤

**–§–æ—Ä–º—É–ª–∞:** `–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–≤–æ—Ä–∫–µ—Ä–æ–≤ = ceil(–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π / 30)`

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **–†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏:**
   ```bash
   redis-cli LLEN rq:queue:img_queue
   ```
   - –ù–æ—Ä–º–∞–ª—å–Ω–æ: < 50 –∑–∞–¥–∞—á
   - –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è: 50-100 –∑–∞–¥–∞—á
   - –ö—Ä–∏—Ç–∏—á–Ω–æ: > 100 –∑–∞–¥–∞—á

2. **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏:**
   - –ù–æ—Ä–º–∞–ª—å–Ω–æ: < 30 —Å–µ–∫—É–Ω–¥
   - –ü—Ä–∏–µ–º–ª–µ–º–æ: 30-60 —Å–µ–∫—É–Ω–¥
   - –ü—Ä–æ–±–ª–µ–º–∞: > 60 —Å–µ–∫—É–Ω–¥

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
   ```bash
   docker stats
   ```
   - CPU: < 70%
   - Memory: < 80%

4. **Rate limit hits:**
   ```bash
   redis-cli KEYS "rate_limit:*" | wc -l
   ```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –û—á–µ—Ä–µ–¥—å —Ä–∞—Å—Ç–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ—Ä–∫–µ—Ä–æ–≤
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å polling –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å –≤–æ—Ä–∫–µ—Ä–æ–≤ –≤ docker-compose
2. –î–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –ø–∞–º—è—Ç–∏ –≤ –∫–æ–¥
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å streaming –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–Ω–æ–≥–æ rate limit –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á–∏—Ç—å `RATE_LIMIT_MAX_REQUESTS`
2. –£–º–µ–Ω—å—à–∏—Ç—å `RATE_LIMIT_WINDOW`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Å–ø–∞–º-–±–æ—Ç–æ–≤

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω—ã –≤–æ—Ä–∫–µ—Ä—ã (5-10 –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω rate limiting –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã polling –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω Redis —Å maxmemory
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–ª–µ—Ä—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:

‚úÖ **100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞  
‚úÖ **200 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏  
‚úÖ **300 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –†–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–º–æ–∂–Ω—ã –ø–∏–∫–æ–≤—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏  

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: < 30 —Å–µ–∫
- –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏: < 50 –∑–∞–¥–∞—á
- –û—à–∏–±–∫–∏: < 1%

