# Анализ рисков при выполнении рекомендаций для масштабирования

## 1. Увеличить max_connections PostgreSQL до 200-300

### Риски: ⚠️ НИЗКИЙ
- **Что делаем:** Изменяем параметр `max_connections` в PostgreSQL
- **Требует перезапуска:** Да (PostgreSQL контейнер)
- **Время простоя:** ~10-30 секунд

**Потенциальные проблемы:**
- ✅ **Низкий риск:** Это стандартная настройка PostgreSQL
- ⚠️ **Память:** Каждое подключение потребляет ~2-4 MB памяти
  - 200 подключений × 3 MB = ~600 MB дополнительной памяти
  - Текущий лимит PostgreSQL: 2 GB, используется: 32 MB
  - **Запас достаточен:** 2 GB - 600 MB = 1.4 GB свободно
- ✅ **Безопасно:** Изменение не влияет на данные, только на конфигурацию

**Рекомендация:** ✅ **БЕЗОПАСНО** - можно выполнять без риска

---

## 2. Добавить swap 2-4 GB

### Риски: ⚠️ СРЕДНИЙ
- **Что делаем:** Создаем swap-файл на диске
- **Требует перезапуска:** Нет (можно добавить без перезапуска)
- **Время простоя:** Нет

**Потенциальные проблемы:**
- ⚠️ **Место на диске:** Нужно 2-4 GB свободного места
  - Текущий свободный диск: 104 GB
  - **Достаточно места:** ✅
- ⚠️ **Производительность:** Swap медленнее RAM (но лучше, чем OOM kill)
- ✅ **Безопасно:** Swap не влияет на работу системы, только добавляет буфер
- ⚠️ **Настройка:** Нужно правильно настроить swappiness (рекомендуется 10-20)

**Рекомендация:** ✅ **БЕЗОПАСНО** - но нужно правильно настроить

---

## 3. Добавить лимит памяти для Bot (512MB-1GB)

### Риски: ✅ ОЧЕНЬ НИЗКИЙ
- **Что делаем:** Добавляем `deploy.resources.limits.memory` в docker-compose
- **Требует перезапуска:** Да (Bot контейнер)
- **Время простоя:** ~10-20 секунд

**Потенциальные проблемы:**
- ✅ **Очень низкий риск:** Это только ограничение, не изменение логики
- ✅ **Текущее использование:** Bot использует 155 MB
- ✅ **Лимит 512MB-1GB:** Более чем достаточно (в 3-6 раз больше текущего)
- ⚠️ **Если лимит слишком мал:** Bot может быть убит OOM killer
  - Но 512MB достаточно для текущей нагрузки
- ✅ **Безопасно:** Изменение только в docker-compose.yml, не влияет на данные

**Рекомендация:** ✅ **ОЧЕНЬ БЕЗОПАСНО** - можно выполнять без риска

---

## 4. Настроить мониторинг

### Риски: ✅ ОЧЕНЬ НИЗКИЙ
- **Что делаем:** Устанавливаем инструменты мониторинга (Prometheus, Grafana, или простые скрипты)
- **Требует перезапуска:** Нет (можно добавить отдельные контейнеры)
- **Время простоя:** Нет

**Потенциальные проблемы:**
- ✅ **Очень низкий риск:** Мониторинг только читает данные, не изменяет систему
- ⚠️ **Ресурсы:** Мониторинг потребляет немного CPU/RAM
  - Prometheus: ~100-200 MB RAM
  - Grafana: ~50-100 MB RAM
  - **Достаточно ресурсов:** ✅
- ✅ **Безопасно:** Не влияет на работу основных сервисов

**Рекомендация:** ✅ **ОЧЕНЬ БЕЗОПАСНО** - можно выполнять без риска

---

## Итоговая оценка рисков

### Общий риск: ⚠️ НИЗКИЙ

**Безопасные операции (можно выполнять сразу):**
1. ✅ Добавить лимит памяти для Bot - **ОЧЕНЬ НИЗКИЙ РИСК**
2. ✅ Настроить мониторинг - **ОЧЕНЬ НИЗКИЙ РИСК**

**Операции с минимальным риском (требуют осторожности):**
3. ⚠️ Увеличить max_connections PostgreSQL - **НИЗКИЙ РИСК** (нужен перезапуск)
4. ⚠️ Добавить swap - **СРЕДНИЙ РИСК** (нужна правильная настройка)

### Рекомендации по порядку выполнения:

1. **Сначала:** Добавить лимит памяти для Bot (самое безопасное)
2. **Затем:** Настроить мониторинг (чтобы видеть изменения)
3. **Потом:** Добавить swap (создает буфер безопасности)
4. **В последнюю очередь:** Увеличить max_connections PostgreSQL (требует перезапуска)

### Меры предосторожности:

1. **Сделать резервную копию БД** перед изменением PostgreSQL:
   ```bash
   docker exec deploy-postgres-1 pg_dump -U media_lab_user media_lab > backup_$(date +%Y%m%d).sql
   ```

2. **Выполнять в нерабочее время** (если есть пиковые нагрузки)

3. **Мониторить после изменений** в течение 1-2 часов

4. **Иметь план отката** (знать, как вернуть настройки обратно)

---

## Вывод

**Все операции безопасны при правильном выполнении.** Риск поломки системы минимален, так как:
- Изменения затрагивают только конфигурацию, не данные
- Есть достаточные ресурсы для всех изменений
- Можно выполнять постепенно с проверкой после каждого шага
- Есть возможность отката изменений

**Рекомендация:** Можно выполнять все операции, но лучше делать это постепенно и с мониторингом.




