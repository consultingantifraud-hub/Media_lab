# Политика хранения данных

## Бессрочное хранение (для продаж продуктов)

Следующие данные сохраняются **бессрочно** в сжатом виде:

### 1. Основная информация о пользователях
- **Таблица `users`**: 
  - Telegram ID, username, имя, язык
  - Email для чеков
  - Статус Premium
  - Дата регистрации и последней активности
  - Бесплатные операции

### 2. Балансы пользователей
- **Таблица `balances`**:
  - Текущий баланс каждого пользователя
  - Дата последнего обновления

### 3. Сводная статистика (ключевая информация для продаж)
- **Таблица `user_statistics`**:
  - Общее количество операций (`total_operations`)
  - Общая сумма потраченных средств (`total_spent`)
  - Операции по типам (`operations_by_type`): JSON с разбивкой по типам операций
  - Использованные модели (`models_used`): JSON с информацией о моделях
  - Дата первой и последней операции

### 4. Промокоды
- **Таблица `discount_codes`**:
  - Все промокоды и их настройки
  - Статистика использования

## Временное хранение (удаляется автоматически)

### Детальные транзакции (удаляются через 180 дней)
- **Таблица `operations`**: Детальные записи операций
  - ⚠️ **Удаляются**, но сводная информация сохраняется в `user_statistics`
  
- **Таблица `payments`**: Детальные записи платежей
  - ⚠️ **Удаляются**, но сводная информация сохраняется в `user_statistics`

### Вспомогательные данные (удаляются через 90-180 дней)
- **Таблица `ai_assistant_questions`**: Вопросы к AI ассистенту (90 дней)
- **Таблица `user_discount_codes`**: Связи пользователей с промокодами (180 дней)

## Автоматические процессы

### Еженедельная оптимизация (воскресенье, 04:00 МСК)
- Скрипт: `/opt/media-lab/deploy/scripts/postgres_optimize.sh`
- Действия:
  1. VACUUM ANALYZE всех таблиц
  2. Обновление сводной статистики из детальных данных
  3. Удаление старых детальных транзакций (старше 180 дней)
  4. Финальный VACUUM

### Ежемесячная архивация (1-е число, 05:00 МСК)
- Скрипт: `/opt/media-lab/deploy/scripts/postgres_archive.sh`
- Действия:
  1. Создание сжатого дампа важных данных
  2. Сохранение в `/opt/backups/media-lab/archive/`
  3. Удаление архивов старше 1 года (оставляются последние 12 месяцев)

## Восстановление данных

Архивы можно восстановить командой:
```bash
gunzip < /opt/backups/media-lab/archive/users_archive_YYYYMMDD_HHMMSS.sql.gz | \
docker exec -i deploy-postgres-1 psql -U media_lab_user -d media_lab
```

## Важно

- **Данные о пользователях никогда не удаляются**
- **Сводная статистика обновляется перед удалением детальных транзакций**
- **Архивы создаются ежемесячно в сжатом виде для бессрочного хранения**

