# –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –Ω–∞ VPS

## üìä –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ‚ö†Ô∏è **–¢–†–ï–ë–£–ï–¢–°–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø**

–ë–æ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω, –Ω–æ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–µ—Å—è—Ç–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å —Å–µ—Ä—å–µ–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò

### 1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Connection Pooling –¥–ª—è HTTP –∫–ª–∏–µ–Ω—Ç–æ–≤** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í `app/providers/fal/client.py` —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π `httpx.Client` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ù–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ü—Ä–∏ 30+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö —ç—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Å–æ—Ç–Ω–∏ –Ω–æ–≤—ã—Ö TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–§–∞–π–ª—ã:**
- `app/providers/fal/client.py` (—Å—Ç—Ä–æ–∫–∏ 82, 105, 137)
- `app/providers/fal/images.py` (—Å—Ç—Ä–æ–∫–∞ 79)

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –°–æ–∑–¥–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Å connection pool
_http_client = httpx.AsyncClient(
    timeout=httpx.Timeout(60.0),
    limits=httpx.Limits(max_keepalive_connections=20, max_connections=100)
)
```

**–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ 30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å 300+ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ 20-30.

---

### 2. **Redis Connection –±–µ–∑ –ø—É–ª–∞** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `app/core/redis.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@lru_cache` - –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å
- –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ —ç—Ç–æ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ
- –ù–µ—Ç connection pooling

**–§–∞–π–ª:** `app/core/redis.py`

**–†–µ—à–µ–Ω–∏–µ:**
```python
import redis.connection
from redis.connection import ConnectionPool

_redis_pool = ConnectionPool.from_url(
    settings.redis_url,
    max_connections=50,
    decode_responses=False
)

def get_redis_connection() -> redis.Redis:
    return redis.Redis(connection_pool=_redis_pool)
```

**–í–ª–∏—è–Ω–∏–µ:** –ú–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

---

### 3. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã asyncio.run()** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í –≤–æ—Ä–∫–µ—Ä–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `asyncio.run()` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (44 –º–µ—Å—Ç–∞!)
- –≠—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ –≤–æ—Ä–∫–µ—Ä–∞
- –ü—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö —Å–æ–∑–¥–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å

**–§–∞–π–ª:** `app/workers/image_worker.py` (44 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

**–ü—Ä–∏–º–µ—Ä:**
```python
asyncio.run(_send_success_notification(...))  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫!
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π async event loop –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram Bot API –∫–ª–∏–µ–Ω—Ç

**–í–ª–∏—è–Ω–∏–µ:** –ö–∞–∂–¥–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–æ—Ä–∫–µ—Ä –Ω–∞ 100-500ms.

---

### 4. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ Bot —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** ‚ö†Ô∏è –í–´–°–û–ö–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í `_send_success_notification()` —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π `Bot()` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
- –ö–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

**–§–∞–π–ª:** `app/workers/image_worker.py` (—Å—Ç—Ä–æ–∫–∏ 144, 190)

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–π bot —ç–∫–∑–µ–º–ø–ª—è—Ä
_bot_instance = None

def get_bot():
    global _bot_instance
    if _bot_instance is None:
        _bot_instance = Bot(token=settings.tg_bot_token)
    return _bot_instance
```

**–í–ª–∏—è–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞ 50-200ms.

---

### 5. **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –ø–∞–º—è—Ç—å** ‚ö†Ô∏è –°–†–ï–î–ù–ï

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –ø–∞–º—è—Ç—å –¥–ª—è base64 encoding
- –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –º–æ–∂–µ—Ç –∏—Å—á–µ—Ä–ø–∞—Ç—å –ø–∞–º—è—Ç—å

**–§–∞–π–ª—ã:**
- `app/providers/fal/images.py` (`_encode_file_to_data_url`, `_encode_bytes_to_png_data_url`)
- `app/workers/image_worker.py` (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ bytes)

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å streaming –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π (—É–∂–µ –µ—Å—Ç—å –¥–ª—è retoucher - 10MB)

**–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ 30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö —Å —Ñ–∞–π–ª–∞–º–∏ –ø–æ 5-10MB = 150-300MB RAM —Ç–æ–ª—å–∫–æ –Ω–∞ —Ñ–∞–π–ª—ã.

---

### 6. **–ê–∫—Ç–∏–≤–Ω—ã–π Polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É** ‚ö†Ô∏è –°–†–ï–î–ù–ï

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (–¥–æ 240 –ø–æ–ø—ã—Ç–æ–∫ = 4 –º–∏–Ω—É—Ç—ã)
- –ü—Ä–∏ 30 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö = 30 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ –∫ fal.ai API
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ rate limiting

**–§–∞–π–ª:** `app/workers/image_worker.py` (polling –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö)

**–ü—Ä–∏–º–µ—Ä—ã:**
- `process_image_job`: polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (—Å—Ç—Ä–æ–∫–∞ 676)
- `process_retoucher_job`: polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (—Å—Ç—Ä–æ–∫–∞ 1132)
- `process_image_edit_job`: polling –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (—Å—Ç—Ä–æ–∫–∞ 848)

**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª polling –¥–æ 2-3 —Å–µ–∫—É–Ω–¥
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å exponential backoff
- –î–æ–±–∞–≤–∏—Ç—å rate limiting –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞

**–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ 30 –∑–∞–¥–∞—á–∞—Ö = 1800 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É –∫ API.

---

### 7. **Threading –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫** ‚ö†Ô∏è –°–†–ï–î–ù–ï

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ—Ç–æ–∫–∏ –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ (`threading.Thread`)
- –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–¥–∞—á —Å–æ–∑–¥–∞—Å—Ç –º–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤

**–§–∞–π–ª:** `app/workers/image_worker.py` (—Å—Ç—Ä–æ–∫–∞ 128)

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ThreadPoolExecutor —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ—Ç–æ–∫–æ–≤
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async –∑–∞–≥—Ä—É–∑–∫—É

**–í–ª–∏—è–Ω–∏–µ:** –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å 100+ –ø–æ—Ç–æ–∫–æ–≤ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

---

### 8. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Rate Limiting** ‚ö†Ô∏è –°–†–ï–î–ù–ï

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```python
from aiogram.filters import BaseFilter

class RateLimitFilter(BaseFilter):
    async def __call__(self, message: types.Message) -> bool:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit —á–µ—Ä–µ–∑ Redis
        ...
```

---

## üü° –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 9. **–ö—ç—à –∑–∞–¥–∞—á –≤ –ø–∞–º—è—Ç–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `_TASK_CACHE` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –≤–æ—Ä–∫–µ—Ä–∞ —Ç–µ—Ä—è–µ—Ç—Å—è
- –ú–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ

**–§–∞–π–ª:** `app/providers/fal/images.py` (—Å—Ç—Ä–æ–∫–∞ 88)

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è –∫—ç—à–∞
- –ò–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞

---

### 10. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –°–ª–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π Redis

---

### 11. **–¢–∞–π–º–∞—É—Ç—ã –∑–∞–¥–∞—á**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –¢–∞–π–º–∞—É—Ç—ã –∑–∞–¥–∞—á —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (600 —Å–µ–∫ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞)
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞—á–∏ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–æ–ª—å—à–µ
- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ –∑–∞–¥–∞—á–∞ —Ç–µ—Ä—è–µ—Ç—Å—è

**–§–∞–π–ª:** `app/bot/services/jobs.py`

**–†–µ—à–µ–Ω–∏–µ:**
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
- Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤

---

## üü¢ –•–û–†–û–®–ò–ï –ü–†–ê–ö–¢–ò–ö–ò (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–´)

‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π (RQ) –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏  
‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ  
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å retry –ª–æ–≥–∏–∫–æ–π  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π  
‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è  
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ async/await –≤ –±–æ—Ç–µ (aiogram)  

---

## üìã –ü–õ–ê–ù –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò –ü–ï–†–ï–î –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï–ú

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û - —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º):

1. ‚úÖ **Connection Pooling –¥–ª—è HTTP –∫–ª–∏–µ–Ω—Ç–æ–≤**
   - –°–æ–∑–¥–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π `httpx.AsyncClient` –∏–ª–∏ `httpx.Client` —Å –ø—É–ª–æ–º
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

2. ‚úÖ **Redis Connection Pool**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å connection pool –¥–ª—è Redis
   - –£–≤–µ–ª–∏—á–∏—Ç—å max_connections

3. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π Bot —ç–∫–∑–µ–º–ø–ª—è—Ä
   - –ò–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –≤ –≤–æ—Ä–∫–µ—Ä–∞—Ö

4. ‚úÖ **–£–±—Ä–∞—Ç—å asyncio.run() –∏–∑ –≤–æ—Ä–∫–µ—Ä–æ–≤**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram Bot API –∫–ª–∏–µ–Ω—Ç
   - –ò–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π async event loop –≤ –ø–æ—Ç–æ–∫–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–ê–ñ–ù–û - —Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é):

5. ‚úÖ **–£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª polling**
   - –ò–∑–º–µ–Ω–∏—Ç—å —Å 1 —Å–µ–∫ –Ω–∞ 2-3 —Å–µ–∫
   - –î–æ–±–∞–≤–∏—Ç—å exponential backoff

6. ‚úÖ **–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ThreadPoolExecutor
   - –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ 10-20 –ø–æ—Ç–æ–∫–æ–≤

7. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å Rate Limiting**
   - –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–ï–õ–ê–¢–ï–õ–¨–ù–û):

8. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏**
   - –î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π

9. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏**
   - Streaming –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
   - –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

---

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Æ

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è VPS:

- **CPU:** 2-4 —è–¥—Ä–∞
- **RAM:** 4-8 GB (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á)
- **–î–∏—Å–∫:** 50+ GB SSD (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤)
- **–°–µ—Ç—å:** –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ—Ä–∫–µ—Ä–æ–≤:

```bash
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤
# –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: 2-4 –≤–æ—Ä–∫–µ—Ä–∞
rq worker -u redis://localhost:6379/0 img_queue -w 2

# –î–ª—è –≤–∏–¥–µ–æ: 1-2 –≤–æ—Ä–∫–µ—Ä–∞
rq worker -u redis://localhost:6379/0 vid_queue -w 1
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è production:

```env
app_env=vps
log_level=INFO  # –ù–µ DEBUG!
redis_url=redis://localhost:6379/0
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å connection pool –≤ –∫–æ–¥–µ
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–µ–π Redis
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏ CPU
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## ‚ö†Ô∏è –û–¶–ï–ù–ö–ê –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- **5-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- **10-20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚ö†Ô∏è –ú–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏
- **20-30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚ùå –í–µ—Ä–æ—è—Ç–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- **30+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1):
- **20-30 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚úÖ –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ
- **30-50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** ‚ö†Ô∏è –ú–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏
- **50+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –¢—Ä–µ–±—É–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.**

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã** (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –Ω–∞ VPS —Å –æ–∂–∏–¥–∞–µ–º–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –±–æ–ª–µ–µ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ 1
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π (10-20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
3. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ VPS
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
5. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ 2-3




