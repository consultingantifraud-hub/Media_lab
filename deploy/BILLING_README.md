# –°–∏—Å—Ç–µ–º–∞ –±–∏–ª–ª–∏–Ω–≥–∞ –∏ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–∏–ª–ª–∏–Ω–≥–∞ –¥–ª—è Telegram Media Generator Bot —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ÆKassa.

### ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQLAlchemy + Alembic)**
   - 4 —Ç–∞–±–ª–∏—Ü—ã: users, balances, payments, operations
   - –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î

2. **–°–µ—Ä–≤–∏—Å—ã**
   - `BillingService` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º –∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
   - `PaymentService` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa

3. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞**
   - –ö–æ–º–∞–Ω–¥–∞ `/balance` - –ø—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞
   - –ú–µ–Ω—é –æ–ø–ª–∞—Ç—ã —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏ (100/300/500/1000‚ÇΩ)
   - –í–≤–æ–¥ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Å—É–º–º—ã
   - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –ø–ª–∞—Ç–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

4. **Webhook API**
   - Endpoint `/yookassa/webhook` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ÆKassa
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
pip install sqlalchemy alembic
# –î–ª—è PostgreSQL:
pip install psycopg2-binary
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å .env

–°–º. `env.prod.example` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

### 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
alembic upgrade head
```

### 4. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–µ—Ä—ã

**app/bot/main.py:**
```python
from app.bot.handlers import billing
router.include_router(billing.router)
```

**app/web/api.py:**
```python
from app.web import billing
app.include_router(billing.router)
```

### 5. –î–æ–±–∞–≤–∏—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –≤ –ø–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

```python
from app.bot.handlers.billing import check_balance_decorator

@check_balance_decorator("generate")  # –∏–ª–∏ "edit", "merge", –∏ —Ç.–¥.
async def handle_generate(message: Message, operation_id: int):
    # –≤–∞—à –∫–æ–¥
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **BILLING_DEPLOYMENT.md** - –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- **BILLING_INTEGRATION_GUIDE.md** - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **INTEGRATION_EXAMPLES.md** - –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
- **BILLING_SUMMARY.md** - —Ä–µ–∑—é–º–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- **BILLING_QUICK_START.md** - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# Billing
PRICE_PER_OPERATION=10
FREE_OPERATIONS_COUNT=4

# Database
DATABASE_URL=postgresql://user:password@localhost/media_lab

# YooKassa
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_RETURN_URL=https://t.me/your_bot
YOOKASSA_WEBHOOK_URL=https://your-domain.com/yookassa/webhook
```

## üìä –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

- **–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:** 4 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `/start`
- **–ü–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:** 10‚ÇΩ –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é (–ø–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö)
- **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º:** "–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç" - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–ø–ª–∞—Ç—ã
- **–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Fal.ai

## üîó Webhook URL

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:
```
https://your-domain.com/yookassa/webhook
```

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—Å–º. `BILLING_INTEGRATION_GUIDE.md`)
2. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å" –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL –≤ –ÆKassa
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

