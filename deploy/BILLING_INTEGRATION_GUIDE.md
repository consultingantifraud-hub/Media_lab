# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–∏–ª–ª–∏–Ω–≥–∞ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –±–æ—Ç–∞.

## üîß –®–∞–≥–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–µ—Ä –±–∏–ª–ª–∏–Ω–≥–∞ –≤ main.py

–í —Ñ–∞–π–ª–µ `app/bot/main.py` –¥–æ–±–∞–≤—å—Ç–µ:

```python
from app.bot.handlers import billing

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
router = Router()
router.include_router(billing.router)
```

### 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å webhook —Ä–æ—É—Ç–µ—Ä –≤ API

–í —Ñ–∞–π–ª–µ `app/web/api.py` –¥–æ–±–∞–≤—å—Ç–µ:

```python
from app.web import billing

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è app
app.include_router(billing.router)
```

### 3. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å" –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

–í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `/start` –¥–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É:

```python
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

def build_main_keyboard():
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ ...
        [
            InlineKeyboardButton(
                text="üí∞ –û–ø–ª–∞—Ç–∏—Ç—å / –ë–∞–ª–∞–Ω—Å",
                callback_data="payment_menu"
            )
        ]
    ])
    return keyboard
```

### 4. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞ –≤ –ø–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

#### –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ä–µ–∂–∏–º–∞ "–°–æ–∑–¥–∞—Ç—å":

```python
from app.bot.handlers.billing import check_balance_decorator
from app.db.base import SessionLocal
from app.services.billing import BillingService

@router.message(...)  # –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∏–ª—å—Ç—Ä
@check_balance_decorator("generate")
async def handle_generate(message: Message, operation_id: int):
    """
    operation_id –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º
    –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    """
    # –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    # ...
    
    # –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å operation_id:
    task = queue.enqueue(
        generate_image_task,
        prompt=prompt,
        operation_id=operation_id  # –¥–ª—è —Å–≤—è–∑–∏ —Å –æ–ø–µ—Ä–∞—Ü–∏–µ–π –±–∏–ª–ª–∏–Ω–≥–∞
    )
```

#### –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ä–µ–∂–∏–º–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å":

```python
@router.message(...)
@check_balance_decorator("edit")
async def handle_edit(message: Message, operation_id: int):
    # –í–∞—à –∫–æ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    ...
```

#### –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ä–µ–∂–∏–º–∞ "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å":

```python
@router.message(...)
@check_balance_decorator("merge")
async def handle_merge(message: Message, operation_id: int):
    # –í–∞—à –∫–æ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
    ...
```

#### –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ó–∞–º–µ–Ω–∏—Ç—å –ª–∏—Ü–æ":

```python
@router.message(...)
@check_balance_decorator("face_swap")
async def handle_face_swap(message: Message, operation_id: int):
    # –í–∞—à –∫–æ–¥ –∑–∞–º–µ–Ω—ã –ª–∏—Ü–∞
    ...
```

#### –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ä–µ–∂–∏–º–∞ "–†–µ—Ç—É—à—å":

```python
@router.message(...)
@check_balance_decorator("retouch")
async def handle_retouch(message: Message, operation_id: int):
    # –í–∞—à –∫–æ–¥ —Ä–µ—Ç—É—à–∏
    ...
```

#### –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ä–µ–∂–∏–º–∞ "–£–ª—É—á—à–∏—Ç—å":

```python
@router.message(...)
@check_balance_decorator("upscale")
async def handle_upscale(message: Message, operation_id: int):
    # –í–∞—à –∫–æ–¥ —É–ª—É—á—à–µ–Ω–∏—è
    ...
```

### 5. –†–µ–∂–∏–º "–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç" - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–†–µ–∂–∏–º "üìù –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç" **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–∏–ª–ª–∏–Ω–≥–∞, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

### 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –≤–æ—Ä–∫–µ—Ä–∞—Ö

–í –≤–æ—Ä–∫–µ—Ä–∞—Ö (—Ñ–∞–π–ª—ã –≤ `app/workers/`) –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Fal.ai –Ω—É–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞:

```python
from app.services.billing import BillingService
from app.db.base import SessionLocal

def process_image_task(task_data):
    operation_id = task_data.get("operation_id")
    
    try:
        # –í–∞—à –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ Fal.ai
        result = fal_client.generate(...)
        return result
    except Exception as e:
        # –ü—Ä–∏ –æ—à–∏–±–∫–µ - –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞
        if operation_id:
            db = SessionLocal()
            try:
                BillingService.refund_operation(db, operation_id)
                logger.info(f"Refunded operation due to error: operation_id={operation_id}")
            finally:
                db.close()
        
        raise  # –ü—Ä–æ–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
```

## üìù –ú–∞–ø–ø–∏–Ω–≥ —Ä–µ–∂–∏–º–æ–≤ –Ω–∞ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π

| –†–µ–∂–∏–º | –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ | –ü–ª–∞—Ç–Ω—ã–π? |
|-------|--------------|----------|
| üé® –°–æ–∑–¥–∞—Ç—å | `generate` | –î–∞ |
| ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å | `edit` | –î–∞ |
| üîó –û–±—ä–µ–¥–∏–Ω–∏—Ç—å | `merge` | –î–∞ |
| üîÑ –ó–∞–º–µ–Ω–∏—Ç—å –ª–∏—Ü–æ | `face_swap` | –î–∞ |
| ‚ú® –†–µ—Ç—É—à—å | `retouch` | –î–∞ |
| ‚¨ÜÔ∏è –£–ª—É—á—à–∏—Ç—å | `upscale` | –î–∞ |
| üìù –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç | `add_text` | –ù–µ—Ç |

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –¢–µ—Å—Ç 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `/balance` - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 4 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–ª–∞—Ç–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é - –¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `/balance` - –¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è 3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### –¢–µ—Å—Ç 2: –û–ø–ª–∞—Ç–∞

1. –ù–∞–∂–º–∏—Ç–µ "üí∞ –û–ø–ª–∞—Ç–∏—Ç—å / –ë–∞–ª–∞–Ω—Å"
2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100‚ÇΩ)
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ (–≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ÆKassa)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `/balance` - –±–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –ø–æ–ø–æ–ª–Ω–∏—Ç—å—Å—è

### –¢–µ—Å—Ç 3: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–ª–∞–Ω—Å < 10‚ÇΩ –∏ –Ω–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–ª–∞—Ç–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
3. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤ —Å –∫–Ω–æ–ø–∫–æ–π –æ–ø–ª–∞—Ç—ã

### –¢–µ—Å—Ç 4: –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–ª–∞—Ç–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (—Å –æ–ø–ª–∞—Ç–æ–π, –Ω–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é)
2. –°–∏–º—É–ª–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫—É –≤ –≤–æ—Ä–∫–µ—Ä–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å - –¥–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è 10‚ÇΩ

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –±–∏–ª–ª–∏–Ω–≥–∞

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–∏–ª–ª–∏–Ω–≥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `loguru`. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
# –õ–æ–≥–∏ –±–æ—Ç–∞
sudo journalctl -u media-lab-bot -f | grep billing

# –õ–æ–≥–∏ API (webhook)
sudo journalctl -u media-lab-api -f | grep yookassa
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT o.*, u.telegram_id 
FROM operations o 
JOIN users u ON o.user_id = u.id 
WHERE u.telegram_id = YOUR_TELEGRAM_ID 
ORDER BY o.created_at DESC 
LIMIT 10;

-- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT u.telegram_id, b.balance, u.free_operations_left
FROM users u 
LEFT JOIN balances b ON u.id = b.user_id 
WHERE u.telegram_id = YOUR_TELEGRAM_ID;
```

## üìö –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

- `app/db/` - –º–æ–¥–µ–ª–∏ –ë–î
- `app/services/billing.py` - —Å–µ—Ä–≤–∏—Å –±–∏–ª–ª–∏–Ω–≥–∞
- `app/services/payment.py` - —Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π
- `app/bot/handlers/billing.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø–ª–∞—Ç—ã
- `app/web/billing.py` - webhook endpoint
- `alembic/` - –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

- `app/bot/main.py` - –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç–µ—Ä –±–∏–ª–ª–∏–Ω–≥–∞
- `app/web/api.py` - –¥–æ–±–∞–≤–∏—Ç—å webhook —Ä–æ—É—Ç–µ—Ä
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ - –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω —Ä–æ—É—Ç–µ—Ä –±–∏–ª–ª–∏–Ω–≥–∞ –≤ `app/bot/main.py`
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω webhook —Ä–æ—É—Ç–µ—Ä –≤ `app/web/api.py`
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å" –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- [ ] –î–æ–±–∞–≤–ª–µ–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@check_balance_decorator` –≤–æ –≤—Å–µ –ø–ª–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ –≤ –≤–æ—Ä–∫–µ—Ä–∞—Ö –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω `.env` —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –±–∏–ª–ª–∏–Ω–≥–∞
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (`alembic upgrade head`)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω webhook URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ–ø–ª–∞—Ç–∞ –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π




