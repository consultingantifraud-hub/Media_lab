# Анализ моделей апскейла в fal.ai

## Текущие модели в коде

### 1. `fal-ai/recraft/upscale/crisp` ✅ (ТЕКУЩАЯ)
- **Тип**: Queue API (асинхронная обработка)
- **Формат вывода**: PNG (изменено с JPEG)
- **Особенности**: 
  - Качественный апскейл с сохранением деталей
  - Поддерживает параметр `scale` (обычно 2x)
  - Ранее возвращал файлы ~15-16 МБ (слишком большие)
  - Теперь настроен на PNG формат для лучшего качества

### 2. `fal-ai/recraft/upscale/creative`
- **Тип**: Queue API (асинхронная обработка)
- **Формат вывода**: JPEG (quality=50)
- **Особенности**:
  - Более творческий подход к апскейлу
  - Может добавлять детали, которых не было в оригинале
  - Меньший размер файла из-за JPEG

### 3. `fal-ai/esrgan` ❌ (ПРОБЛЕМНАЯ)
- **Тип**: Queue API (асинхронная обработка)
- **Формат вывода**: PNG
- **Особенности**:
  - Возвращает очень большие файлы (19+ МБ из 1 МБ входного)
  - Медленное скачивание
  - Проблемы с SSL таймаутами
  - Не подходит для наших целей (3-5 МБ)

## Проблемы, которые были решены

1. **Файл отправлялся по URL вместо bytes** → Telegram сжимал до 185 КБ
   - **Решение**: Изменено `skip_download=False` для синхронного скачивания
   - Теперь файл скачивается локально и отправляется как `image_bytes`

2. **Модель `esrgan` возвращала слишком большие файлы**
   - **Решение**: Вернулись к `recraft/upscale/crisp` с PNG форматом

3. **Формат вывода был JPEG с низким качеством**
   - **Решение**: Изменен на PNG для лучшего качества (как в Smart merge)

## Рекомендации

### Текущая конфигурация (рекомендуется):
- **Модель**: `fal-ai/recraft/upscale/crisp`
- **Формат**: PNG
- **Scale**: 2x (по умолчанию)
- **Логика**: Синхронное скачивание перед отправкой

### Альтернативные варианты для тестирования:

1. **`fal-ai/recraft/upscale/creative`** с PNG форматом
   - Может дать более интересные результаты
   - Нужно протестировать размер файла

2. **Другие модели fal.ai** (требуют исследования):
   - Возможно есть модели с лучшим контролем размера файла
   - Нужно проверить документацию fal.ai

## Следующие шаги

1. ✅ Исправлена логика скачивания (синхронное вместо фонового)
2. ✅ Вернулись к `recraft/upscale/crisp` с PNG форматом
3. ⏳ Протестировать текущую конфигурацию
4. ⏳ Если проблема сохраняется - исследовать другие модели в fal.ai

## Важные моменты

- **Smart merge работает корректно** потому что использует ту же логику (`_persist_asset` с `skip_download=False`)
- **Проблема была в том**, что для upscale использовался `skip_download=True`, что приводило к отправке по URL
- **Telegram автоматически сжимает** изображения, отправленные по URL, до ~185 КБ
- **Решение**: Всегда скачивать файл локально и отправлять как `image_bytes` через `BufferedInputFile`





