# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–∞

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ú–æ–¥–µ–ª–∏ –ë–î –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

**–¢–∞–±–ª–∏—Ü–∞ `discount_codes`:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π –∏ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π

**–¢–∞–±–ª–∏—Ü–∞ `user_discount_codes`:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –°–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

### 2. –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ (`app/services/discount.py`)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `validate_discount_code()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `apply_discount_to_payment()` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏ –∫ –ø–ª–∞—Ç–µ–∂—É
- `apply_free_generation_code()` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- `create_discount_code()` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `get_discount_info()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–º–æ–∫–æ–¥–µ

### 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ –±–æ—Ç–µ

**–ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
- `payment_discount_code` - –≤–≤–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
- `free_generation_code` - –≤–≤–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

**–ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM:**
- `WAIT_DISCOUNT_CODE` - –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã
- `WAIT_FREE_GENERATION_CODE` - –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

### 4. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã

–°–æ–∑–¥–∞–Ω—ã –ø—Ä–æ–º–æ–∫–æ–¥—ã —Å–æ —Å–∫–∏–¥–∫–æ–π:
- **WELCOME10** - —Å–∫–∏–¥–∫–∞ 10%
- **SAVE20** - —Å–∫–∏–¥–∫–∞ 20%
- **BONUS30** - —Å–∫–∏–¥–∫–∞ 30%
- **MEGA50** - —Å–∫–∏–¥–∫–∞ 50%

### 5. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `002_add_discount_codes.py` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.

### 6. –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/init_discount_codes.py` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.

## üîÑ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ:

1. –ù–∞–∂–º–∏—Ç–µ "üí∞ –û–ø–ª–∞—Ç–∏—Ç—å / –ë–∞–ª–∞–Ω—Å"
2. –í—ã–±–µ—Ä–∏—Ç–µ "üéüÔ∏è –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥"
3. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DISCOUNT20)
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
5. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:

1. –ù–∞–∂–º–∏—Ç–µ `/balance`
2. –í—ã–±–µ—Ä–∏—Ç–µ "üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π"
3. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
4. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—á–µ—Ç

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

#### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:

```python
from app.db.base import SessionLocal
from app.services.discount import DiscountService
from datetime import datetime

db = SessionLocal()

# –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ —Å–∫–∏–¥–∫–æ–π 25%
DiscountService.create_discount_code(
    db,
    code="PROMO25",
    discount_percent=25,
    max_uses=100
)

# –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è 5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
DiscountService.create_discount_code(
    db,
    code="FREE5",
    discount_percent=0,
    is_free_generation=True,
    free_generations_count=5,
    max_uses=50
)

db.close()
```

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:

```bash
python scripts/init_discount_codes.py
```

## üìã –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
alembic upgrade head

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
python scripts/init_discount_codes.py
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `alembic upgrade head`
2. –°–æ–∑–¥–∞–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã: `python scripts/init_discount_codes.py`
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤–≤–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ `DISCOUNT_CODES_GUIDE.md`.

