#!/bin/bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ —á–µ—Ä–µ–∑ cron

REPO_DIR="/opt/media-lab"
SCRIPT_PATH="$REPO_DIR/auto_commit.sh"
CRON_LOG="/opt/media-lab/logs/git_cron.log"

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ –Ω–∞ GitHub ==="
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç $SCRIPT_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω."
    exit 1
fi

chmod +x "$SCRIPT_PATH"
echo "‚úÖ –°–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"

# 2. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p "$(dirname "$CRON_LOG")"
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∞"

# 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π cron
echo ""
echo "=== –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ cron ==="
crontab -l 2>/dev/null | grep -E "auto_commit|git" || echo "–ù–µ—Ç –∑–∞–¥–∞—á Git –≤ cron"

# 4. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:"
echo "1) –ö–∞–∂–¥—ã–π —á–∞—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)"
echo "2) –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"
echo "3) –†–∞–∑ –≤ –¥–µ–Ω—å (–≤ 02:00)"
echo "4) –†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 03:00)"
echo "5) –í—Ä—É—á–Ω—É—é (–±–µ–∑ cron, —Ç–æ–ª—å–∫–æ —Å–∫—Ä–∏–ø—Ç)"
echo ""
read -p "–í–∞—à –≤—ã–±–æ—Ä (1-5): " CHOICE

case $CHOICE in
    1)
        CRON_SCHEDULE="0 * * * *"  # –ö–∞–∂–¥—ã–π —á–∞—Å
        DESCRIPTION="–∫–∞–∂–¥—ã–π —á–∞—Å"
        ;;
    2)
        CRON_SCHEDULE="0 */6 * * *"  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
        DESCRIPTION="–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"
        ;;
    3)
        CRON_SCHEDULE="0 2 * * *"  # –†–∞–∑ –≤ –¥–µ–Ω—å –≤ 2:00
        DESCRIPTION="—Ä–∞–∑ –≤ –¥–µ–Ω—å (02:00)"
        ;;
    4)
        CRON_SCHEDULE="0 3 * * 0"  # –†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –≤ 3:00 –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
        DESCRIPTION="—Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 03:00)"
        ;;
    5)
        DESCRIPTION="–≤—Ä—É—á–Ω—É—é"
        CRON_SCHEDULE=""
        ;;
    *)
        echo "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É—é –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Ä–∞–∑ –≤ –¥–µ–Ω—å."
        CRON_SCHEDULE="0 2 * * *"
        DESCRIPTION="—Ä–∞–∑ –≤ –¥–µ–Ω—å (02:00)"
        ;;
esac

# 5. –î–æ–±–∞–≤–ª—è–µ–º –≤ cron
if [ -n "$CRON_SCHEDULE" ]; then
    echo ""
    echo "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ cron: $DESCRIPTION"
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    crontab -l 2>/dev/null | grep -v "auto_commit.sh" | crontab -
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    (crontab -l 2>/dev/null; echo "$CRON_SCHEDULE $SCRIPT_PATH >> $CRON_LOG 2>&1") | crontab -
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ cron!"
        echo ""
        echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: $CRON_SCHEDULE ($DESCRIPTION)"
        echo "–°–∫—Ä–∏–ø—Ç: $SCRIPT_PATH"
        echo "–õ–æ–≥: $CRON_LOG"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≤ cron."
        exit 1
    fi
    
    echo ""
    echo "=== –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ cron ==="
    crontab -l | grep -E "auto_commit|git"
else
    echo ""
    echo "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ."
    echo "–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –≤—Ä—É—á–Ω—É—é:"
    echo "  bash $SCRIPT_PATH"
fi

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫: bash $SCRIPT_PATH"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f $CRON_LOG"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä cron: crontab -l"
echo "  - –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É: crontab -e (—É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å auto_commit.sh)"

