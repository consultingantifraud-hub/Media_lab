# –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üéØ –¶–µ–ª—å
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ **50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –ø—Ä–∏ —Ç–µ–∫—É—â–µ–π –º–æ—â–Ω–æ—Å—Ç–∏ (2.9 GB RAM, 3 CPU cores).

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ vs –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ

### –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):
- Bot: 143.6 MB
- API: 105.3 MB (2 workers)
- Worker: 33.1 MB
- Redis: 5.9 MB
- **–í—Å–µ–≥–æ Docker:** ~288 MB
- **–ù–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** ~31 MB

### –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:
- Bot: ~100-120 MB (–ª–∏–º–∏—Ç 120 MB)
- API: ~50-80 MB (1 worker, –ª–∏–º–∏—Ç 150 MB)
- Worker: ~30-50 MB (–ª–∏–º–∏—Ç 200 MB)
- Redis: ~6-32 MB (–ª–∏–º–∏—Ç 128 MB, maxmemory 256 MB)
- **–í—Å–µ–≥–æ Docker:** ~186-282 MB
- **–ù–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** ~15-20 MB

**–≠–∫–æ–Ω–æ–º–∏—è:** ~70-90 MB (25-30%)

## üîß –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

#### 1.1 API —Å–µ—Ä–≤–µ—Ä
- **–ë—ã–ª–æ:** `--workers 2` (2 –ø—Ä–æ—Ü–µ—Å—Å–∞)
- **–°—Ç–∞–ª–æ:** `--workers 1` (1 –ø—Ä–æ—Ü–µ—Å—Å)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** `--limit-concurrency 100` (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Memory limit:** 150 MB (–±—ã–ª–æ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ)
- **–≠–∫–æ–Ω–æ–º–∏—è:** ~50 MB

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** FastAPI —Å async/await –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ. –î–≤–∞ worker'–∞ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è CPU-bound –∑–∞–¥–∞—á, –∞ —É –Ω–∞—Å I/O-bound (–∑–∞–ø—Ä–æ—Å—ã –∫ API).

#### 1.2 Bot
- **Memory limit:** 120 MB (–±—ã–ª–æ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ)
- **–≠–∫–æ–Ω–æ–º–∏—è:** ~20-30 MB

#### 1.3 Worker
- **Memory limit:** 200 MB (–±—ã–ª–æ 2 GB)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** `--max-jobs 5` (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á)
- **–≠–∫–æ–Ω–æ–º–∏—è:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–∏–∫–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

#### 1.4 Redis
- **Memory limit:** 128 MB (–±—ã–ª–æ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ)
- **maxmemory:** 256 MB (–±—ã–ª–æ 512 MB)
- **–≠–∫–æ–Ω–æ–º–∏—è:** ~128 MB –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏

### 2. –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 2.1 Swappiness
- **–ë—ã–ª–æ:** 60 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **–°—Ç–∞–ª–æ:** 10
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ú–µ–Ω—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è swap, –±–æ–ª—å—à–µ RAM –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

#### 2.2 Dirty ratio
- **dirty_ratio:** 15 (–±—ã–ª–æ 20)
- **dirty_background_ratio:** 5 (–±—ã–ª–æ 10)
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ë–æ–ª–µ–µ —á–∞—Å—Ç–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–∫, –º–µ–Ω—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è –±—É—Ñ–µ—Ä–æ–≤

#### 2.3 –õ–∏–º–∏—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- **nofile:** 65535 (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤)
- **nproc:** 4096 (—É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü–∞–º—è—Ç—å –¥–ª—è 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- **–¢–µ–∫—É—â–µ–µ:** 50 √ó 31 MB = 1,550 MB
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ:** 50 √ó 18 MB = 900 MB
- **–ó–∞–ø–∞—Å:** 2,900 - 900 = 2,000 MB (69%)

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ:** 40-50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ
- **–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ:** 50-60 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ API
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU

### 2. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### API –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø—Ä–∏ –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- **–†–µ—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ API —Å—Ç–∞–Ω–µ—Ç —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 2 workers, –Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å memory limit

#### Worker –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–µ–Ω—å—à–µ –∑–∞–¥–∞—á –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ç–æ—Ä–æ–π worker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

#### Redis –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω
- **–†–µ—à–µ–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ: allkeys-lru)

### 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø):
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ LLM –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Redis
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —Ç–µ–∫—Å—Ç–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ API –Ω–∞ 30-50%

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ streaming –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:
```bash
cd /opt/media-lab/deploy
chmod +x optimize-server.sh
./optimize-server.sh
```

### –†—É—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:
1. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é:
   ```bash
   cp docker-compose.prod.yml docker-compose.prod.yml.backup
   ```

2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
   ```bash
   cp docker-compose.prod.yml.optimized docker-compose.prod.yml
   ```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   docker-compose -f docker-compose.prod.yml down
   docker-compose -f docker-compose.prod.yml up -d
   ```

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
   ```bash
   docker-compose -f docker-compose.prod.yml ps
   docker stats --no-stream
   ```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- **–ü–∞–º—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:** `docker stats`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis:** `redis-cli INFO memory`
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ API:** –õ–æ–≥–∏ API
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –õ–æ–≥–∏ bot
- **–û—à–∏–±–∫–∏:** `docker-compose logs | grep ERROR`

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–≥–∏:
- **–ü–∞–º—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ >90% –ª–∏–º–∏—Ç–∞:** –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ
- **Redis memory >80%:** –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞ –∏–ª–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
- **API –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ >5 —Å–µ–∫:** –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- **–û—à–∏–±–∫–∏ >5%:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ

## üîÑ –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–≤–µ–ª–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º:

```bash
cd /opt/media-lab/deploy
cp docker-compose.prod.yml.backup docker-compose.prod.yml
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (`docker stats`)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ (`docker-compose logs`)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API (`curl http://localhost:8000/health`)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤
- [ ] –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

