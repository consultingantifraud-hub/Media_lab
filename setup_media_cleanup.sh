#!/bin/bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ cron

REPO_DIR="/opt/media-lab"
SCRIPT_PATH="$REPO_DIR/cleanup_old_media.sh"
CRON_LOG="$REPO_DIR/logs/cleanup_media_cron.log"

echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ ==="
echo ""

cd "$REPO_DIR" || exit 1

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç $SCRIPT_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω."
    exit 1
fi

chmod +x "$SCRIPT_PATH"
echo "‚úÖ –°–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤: $SCRIPT_PATH"

# 2. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p "$(dirname "$CRON_LOG")"
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∞"

# 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π cron
echo ""
echo "=== –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ cron (–æ—á–∏—Å—Ç–∫–∞ –º–µ–¥–∏–∞) ==="
crontab -l 2>/dev/null | grep -E "cleanup_old_media|cleanup_media" || echo "–ù–µ—Ç –∑–∞–¥–∞—á –æ—á–∏—Å—Ç–∫–∏ –º–µ–¥–∏–∞ –≤ cron"
echo ""

# 4. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏
echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á –æ—á–∏—Å—Ç–∫–∏ –º–µ–¥–∏–∞..."
crontab -l 2>/dev/null | grep -v "cleanup_old_media.sh" | crontab - 2>/dev/null
echo "‚úÖ –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ —É–¥–∞–ª–µ–Ω—ã"

# 5. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏:"
echo "1) –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
echo "2) –†–∞–∑ –≤ –¥–µ–Ω—å (–≤ 03:00)"
echo "3) –†–∞–∑ –≤ 12 —á–∞—Å–æ–≤"
echo "4) –í—Ä—É—á–Ω—É—é (–±–µ–∑ cron)"
echo ""
read -p "–í–∞—à –≤—ã–±–æ—Ä (1-4): " CHOICE

case $CHOICE in
    1)
        CRON_SCHEDULE="0 */6 * * *"  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
        DESCRIPTION="–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"
        ;;
    2)
        CRON_SCHEDULE="0 3 * * *"  # –†–∞–∑ –≤ –¥–µ–Ω—å –≤ 3:00
        DESCRIPTION="—Ä–∞–∑ –≤ –¥–µ–Ω—å (03:00)"
        ;;
    3)
        CRON_SCHEDULE="0 */12 * * *"  # –ö–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
        DESCRIPTION="–∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤"
        ;;
    4)
        DESCRIPTION="–≤—Ä—É—á–Ω—É—é"
        CRON_SCHEDULE=""
        ;;
    *)
        echo "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É—é –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤."
        CRON_SCHEDULE="0 */6 * * *"
        DESCRIPTION="–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"
        ;;
esac

# 6. –î–æ–±–∞–≤–ª—è–µ–º –≤ cron
if [ -n "$CRON_SCHEDULE" ]; then
    echo ""
    echo "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ cron: $DESCRIPTION"
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π crontab
    TEMP_CRON=$(mktemp)
    crontab -l 2>/dev/null > "$TEMP_CRON"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    cat >> "$TEMP_CRON" << EOF

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ (Media Lab)
$CRON_SCHEDULE $SCRIPT_PATH >> $CRON_LOG 2>&1
EOF
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π crontab
    crontab "$TEMP_CRON"
    rm "$TEMP_CRON"
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ cron!"
        echo ""
        echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: $CRON_SCHEDULE ($DESCRIPTION)"
        echo "–°–∫—Ä–∏–ø—Ç: $SCRIPT_PATH"
        echo "–õ–æ–≥: $CRON_LOG"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≤ cron."
        exit 1
    fi
    
    echo ""
    echo "=== –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –æ—á–∏—Å—Ç–∫–∏ ==="
    crontab -l | grep "cleanup_old_media.sh"
else
    echo ""
    echo "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ."
    echo "–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –≤—Ä—É—á–Ω—É—é:"
    echo "  bash $SCRIPT_PATH"
fi

# 7. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
echo ""
echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–∏—Å—Ç–∫–∏ ==="
echo "–£–¥–∞–ª—è—é—Ç—Å—è —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ: 24 —á–∞—Å–æ–≤"
echo "–ó–∞—â–∏—Ç–∞: —Ñ–∞–π–ª—ã –º–ª–∞–¥—à–µ 30 –º–∏–Ω—É—Ç –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫: bash $SCRIPT_PATH"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f $CRON_LOG"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: crontab -l | grep cleanup"
echo "  - –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å $SCRIPT_PATH"
echo ""

# 8. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ—á–∏—Å—Ç–∫—É —Å–µ–π—á–∞—Å? (y/n): " TEST_RUN

if [ "$TEST_RUN" = "y" ] || [ "$TEST_RUN" = "Y" ]; then
    echo ""
    echo "=== –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ ==="
    bash "$SCRIPT_PATH"
    echo ""
    echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f $CRON_LOG"
else
    echo ""
    echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
fi

echo ""

