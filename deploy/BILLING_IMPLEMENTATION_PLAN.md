# –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –±–∏–ª–ª–∏–Ω–≥–∞ –∏ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa

## üìã –û–±–∑–æ—Ä

–í–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã –∏ –±–∏–ª–ª–∏–Ω–≥–∞ –≤ Telegram Media Generator Bot —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
- SQLAlchemy + Alembic –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- –ÆKassa –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- 4 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
app/
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ base.py              # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∏ engine
‚îÇ   ‚îú‚îÄ‚îÄ models.py            # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ session.py           # –°–µ—Å—Å–∏–∏ –ë–î
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ billing.py           # –°–µ—Ä–≤–∏—Å –±–∏–ª–ª–∏–Ω–≥–∞ (–±–∞–ª–∞–Ω—Å, –æ–ø–µ—Ä–∞—Ü–∏–∏)
‚îÇ   ‚îî‚îÄ‚îÄ payment.py           # –°–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π –ÆKassa
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing.py      # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø–ª–∞—Ç—ã –∏ –±–∞–ª–∞–Ω—Å–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...             # –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ web/
‚îÇ   ‚îî‚îÄ‚îÄ api.py              # –î–æ–±–∞–≤–∏—Ç—å webhook endpoint
‚îî‚îÄ‚îÄ ...

alembic/
‚îú‚îÄ‚îÄ versions/               # –ú–∏–≥—Ä–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ env.py
alembic.ini
```

## üìä –ú–æ–¥–µ–ª–∏ –ë–î

### users
- id (PK)
- telegram_id (unique)
- created_at
- updated_at
- free_operations_left (int, default=0)

### balances
- id (PK)
- user_id (FK -> users.id, unique)
- balance (int, —Ä—É–±–ª–∏, default=0)
- updated_at

### payments
- id (PK)
- user_id (FK -> users.id)
- yookassa_payment_id (string, unique)
- amount (int)
- status (enum: pending, succeeded, canceled, failed, refunded)
- raw_data (JSON)
- created_at
- updated_at

### operations
- id (PK)
- user_id (FK -> users.id)
- type (string: generate, edit, merge, face_swap, retouch, upscale)
- price (int, –º–æ–∂–µ—Ç –±—ã—Ç—å 0)
- status (enum: free, charged, refunded, failed)
- task_id (string/uuid)
- created_at

## üîÑ –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

### –ü–ª–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞/–±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. –ï—Å–ª–∏ –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ ‚Üí —É–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫, —Å–æ–∑–¥–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é (free)
4. –ï—Å–ª–∏ –Ω–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ–º 10‚ÇΩ, —Å–æ–∑–¥–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é (charged)
5. –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤ ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã
6. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
7. –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ (refunded)

### –û–ø–ª–∞—Ç–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å"
2. –í—ã–±–æ—Ä —Å—É–º–º—ã (100/300/500/1000 –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è)
3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (status=pending)
5. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
6. Webhook –æ—Ç –ÆKassa ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ .env:
```
# Billing
PRICE_PER_OPERATION=10
FREE_OPERATIONS_COUNT=4

# Database
DATABASE_URL=postgresql://user:password@localhost/media_lab
# –∏–ª–∏ sqlite:///./media_lab.db –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

# YooKassa
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_RETURN_URL=https://your-domain.com/payment/return
YOOKASSA_CURRENCY=RUB
YOOKASSA_WEBHOOK_URL=https://your-domain.com/yookassa/webhook
```

## üìù –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î –∏ –º–æ–¥–µ–ª–∏
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Alembic
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –±–∏–ª–ª–∏–Ω–≥–∞ –∏ –ø–ª–∞—Ç–µ–∂–µ–π
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞
5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å webhook
7. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
8. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è




