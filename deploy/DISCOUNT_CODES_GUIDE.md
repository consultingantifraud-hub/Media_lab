# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞:
1. **–ü—Ä–æ–º–æ–∫–æ–¥—ã —Å–æ —Å–∫–∏–¥–∫–æ–π** - –¥–∞—é—Ç —Å–∫–∏–¥–∫—É –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ (10%, 20%, 30%, 50%)
2. **–ü—Ä–æ–º–æ–∫–æ–¥—ã –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π** - –¥–æ–±–∞–≤–ª—è—é—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üéüÔ∏è –¢–∏–ø—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

### –ü—Ä–æ–º–æ–∫–æ–¥—ã —Å–æ —Å–∫–∏–¥–∫–æ–π

- **WELCOME10** - —Å–∫–∏–¥–∫–∞ 10%
- **SAVE20** - —Å–∫–∏–¥–∫–∞ 20%
- **BONUS30** - —Å–∫–∏–¥–∫–∞ 30%
- **MEGA50** - —Å–∫–∏–¥–∫–∞ 50%

–≠—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –∏ —É–º–µ–Ω—å—à–∞—é—Ç —Å—É–º–º—É –∫ –æ–ø–ª–∞—Ç–µ.

### –ü—Ä–æ–º–æ–∫–æ–¥—ã –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

–°–æ–∑–¥–∞—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –î–æ–±–∞–≤–ª—è—é—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—á–µ—Ç.

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### –ü—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞:

1. –ù–∞–∂–º–∏—Ç–µ "üí∞ –û–ø–ª–∞—Ç–∏—Ç—å / –ë–∞–ª–∞–Ω—Å"
2. –í—ã–±–µ—Ä–∏—Ç–µ "üéüÔ∏è –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥"
3. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DISCOUNT10)
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
5. –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞

#### –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:

1. –ù–∞–∂–º–∏—Ç–µ `/balance` –∏–ª–∏ "üí∞ –û–ø–ª–∞—Ç–∏—Ç—å / –ë–∞–ª–∞–Ω—Å"
2. –í—ã–±–µ—Ä–∏—Ç–µ "üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π"
3. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
4. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤–∞—à —Å—á–µ—Ç

## üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

### –ß–µ—Ä–µ–∑ Python —Å–∫—Ä–∏–ø—Ç

```python
from app.db.base import SessionLocal
from app.services.discount import DiscountService

db = SessionLocal()

# –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ —Å–∫–∏–¥–∫–æ–π
DiscountService.create_discount_code(
    db,
    code="PROMO20",
    discount_percent=20,
    max_uses=100,  # –ú–∞–∫—Å–∏–º—É–º 100 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
    valid_until=datetime(2025, 12, 31)  # –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ –∫–æ–Ω—Ü–∞ –≥–æ–¥–∞
)

# –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
DiscountService.create_discount_code(
    db,
    code="FREE10",
    discount_percent=0,
    is_free_generation=True,
    free_generations_count=10,  # 10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
    max_uses=50  # –ú–∞–∫—Å–∏–º—É–º 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
)

db.close()
```

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (DISCOUNT10, DISCOUNT20, DISCOUNT30, DISCOUNT50):

```bash
python scripts/init_discount_codes.py
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `discount_codes`

- `id` - ID –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `code` - –ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `discount_percent` - –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (0-100)
- `is_active` - –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥
- `max_uses` - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (NULL = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
- `current_uses` - –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
- `valid_from` - –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è (NULL = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
- `valid_until` - –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è (NULL = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
- `is_free_generation` - –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- `free_generations_count` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

### –¢–∞–±–ª–∏—Ü–∞ `user_discount_codes`

–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `discount_code_id` - ID –ø—Ä–æ–º–æ–∫–æ–¥–∞
- `used_at` - –î–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- `payment_id` - –°–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–æ–º (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ)
- `operation_id` - –°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ü–∏–µ–π (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥–∞ (`is_active = true`)
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (`valid_from`, `valid_until`)
- –õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (`max_uses`)

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

- –ü—Ä–æ–º–æ–∫–æ–¥—ã –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–æ–º–æ–∫–æ–¥—ã —Å–æ —Å–∫–∏–¥–∫–æ–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `max_uses`)

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ —Å–∫–∏–¥–∫–æ–π –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ SAVE20
2. –í—ã–±–∏—Ä–∞–µ—Ç —Å—É–º–º—É 500‚ÇΩ
3. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å–∫–∏–¥–∫–∞ 20% = 100‚ÇΩ
4. –ö –æ–ø–ª–∞—Ç–µ: 400‚ÇΩ

### –ü—Ä–∏–º–µ—Ä 2: –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ FREE10
2. –°–∏—Å—Ç–µ–º–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç 10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤–º–µ—Å—Ç–æ –æ–ø–ª–∞—Ç—ã

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è (—Ä–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω)
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π

### –ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥ –∏–º–µ–µ—Ç `is_free_generation = true`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `free_generations_count > 0`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥

## üìö SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

```sql
SELECT code, discount_percent, is_active, current_uses, max_uses, is_free_generation, free_generations_count
FROM discount_codes
ORDER BY created_at DESC;
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞

```sql
SELECT u.telegram_id, udc.used_at, p.amount as payment_amount
FROM user_discount_codes udc
JOIN users u ON udc.user_id = u.id
LEFT JOIN payments p ON udc.payment_id = p.id
WHERE udc.discount_code_id = (SELECT id FROM discount_codes WHERE code = 'WELCOME10')
ORDER BY udc.used_at DESC;
```

### –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

```sql
UPDATE discount_codes
SET is_active = false
WHERE code = 'WELCOME10';
```

